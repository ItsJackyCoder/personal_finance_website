<!--index.htmlè£¡é¢çš„å…§å®¹æ˜¯å¾base.htmlè£¡é¢çš„å…§å®¹ä¾†çš„-->
{% extends "base.html" %}

<!--ä¸åŒåœ°æ–¹çš„htmlè¦è²¼åœ¨é€™è£¡é¢-->
{% block content%}
<!--Modal-->
<!--data-bs-backdrop="static":ç¦ç”¨é»æ“Šå¤–éƒ¨é—œé–‰ -->
<!--data-bs-keyboard="false":ç¦ç”¨Escé—œé–‰ -->
<!--style="display: none;":é è¨­éš±è—æ­¤å½ˆè·³è¦–çª—"-->
<head>
  <style>
    .blurred {
        filter: blur(10px); /* èª¿æ•´é€™å€‹å€¼ä¾†æ§åˆ¶è™›åŒ–ç¨‹åº¦ */
        transition: filter 0.3s; /* å¹³æ»‘éæ¸¡æ•ˆæœ */
    }
</style>
</head>
<div
  class="modal fade"
  id="introModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"  
  data-bs-keyboard="false" 
  style="display: none;"   
>
  <!--ç™»å…¥è¡¨å–®-->
  <div id="loginPage" class="modal-dialog"> <!--æ¸¬è©¦-->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">WelcomeğŸ‘ğŸ‘ğŸ‘</h5>
      </div>
      <div id= "loginForm" class="modal-body">
        Welcome to the cash and stock warehouse management system! (version: 2024.12.29)<br /><br />
        This is just a test webpage, no need to worry.<br /><br />
        The purpose of this webpage is to manage and track the changes in cash and stock storage.<br /><br />

        <!-- è¡¨å–®é–‹å§‹ --> 
        <!--æäº¤formåˆ°å¾Œç«¯è¦è¨˜å¾—å¯«method="POST"-->
        <form id="userCodeForm" onsubmit="return handleFormSubmit(event)" method="POST">

        <!-- æ–‡å­—æ¡† -->
        <label for="userCode" class="form-label mb-3">Account:</label>
        <div class="input-group mb-3">
          <input
            id="userCodeInput"
            name="userCodeInput"
            type="text"
            class="form-control"
            aria-label="Sizing example input"
            aria-describedby="inputGroup-sizing-default"
            placeholder="Please enter up to 10 English letters or numbers."
            maxlength="10"
            oninput="filterInput(this)"
            required
          />
        </div>

        <label for="pwd" class="form-label mb-3">Password:</label>
        <div class="input-group mb-3">
          <input
            id="pwdInput"
            name="pwdInput"
            type="password"
            class="form-control"
            aria-label="Sizing example input"
            aria-describedby="inputGroup-sizing-default"
            placeholder="Please enter up to 10 English letters or numbers."
            maxlength="10"
            oninput="filterInput(this)"
            required
          />
        </div>

        <!-- ç”¨ä¾†é¡¯ç¤ºéŒ¯èª¤çš„æç¤º --> <!--è¦æ”¹-->
        <div id="inputError" style="color: red; display: none;"></div>
      </div>
      <div class="modal-footer">
        <!--è¨»å†Šbutton-->
        <!--onclick="openRegistrationPage()":å‘¼å«æ‰“é–‹è¨»å†Šé é¢çš„å‡½æ•¸-->
         <button
         type="button"
         class="btn btn-success me-auto"
         onclick="openRegistrationPage()" 
       >
        Register
       </button>

        <!--ä¸éœ€è¦åœ¨æŒ‰éˆ•ä¸Šæ·»åŠ onclickäº‹ä»¶,å› ç‚ºè¡¨å–®æœƒè‡ªå‹•èª¿ç”¨onsubmitäº‹ä»¶-->
        <button
          type="submit"
          class="btn btn-success"
        >
          Login
        </button>
      </div>
    </form>
    <!--è¡¨å–®çµæŸ-->
    </div>
  </div> <!--æ¸¬è©¦-->

    <!--è¨»å†Šè¡¨å–®-->
    <div id="registrationForm" class="modal-dialog" style="display: none;"> <!--æ¸¬è©¦-->
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Register Account</h5>
        </div>
        <div class="modal-body">

      <form id="registerForm" onsubmit="return handleRegistration(event)" method="POST">
        <label for="regUserCode" class="form-label mb-3">Account:</label>
        <div class="input-group mb-3">
          <input
            id="regUserCode"
            name="regUserCode"
            type="text"
            class="form-control"
            aria-label="Sizing example input"
            placeholder="Please enter up to 10 English letters or numbers."
            maxlength="10"
            oninput="filterInput(this)"
            required
          />
        </div>

        <label for="regPwd" class="form-label mb-3">Password:</label>
        <div class="input-group mb-3">
          <input
            id="regPwd"
            name="regPwd"
            type="password"
            class="form-control"
            aria-label="Sizing example input"
            placeholder="Please enter up to 10 English letters or numbers."
            maxlength="10"
            oninput="filterInput(this)"
            required
          />
        </div>

        <div id="regError" style="color: red; display: none;"></div>
       </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-success me-auto"
            onclick="showLoginForm()"
          >
            Return to Login
          </button>

          <button
            type="submit"
            class="btn btn-success"
          >
            Confirm
          </button>
        </div>
      </form>
    </div> <!--è¨»å†Šè¡¨å–®çµæŸ-->

  </div>
</div>

<div id="main-content"><!--è™›åŒ–é–‹å§‹-->
<div id="cash-info">
  <!--&#x1F4B5;æ˜¯éˆ”ç¥¨çš„emoji-->
  <h3>Cash Inventory ğŸ’µ</h3>
  <table class="table" style="text-align: center;">
    <thead class="table-success">
      <tr>
        <th scope="col">Total in TWD</th>
        <th scope="col">Total in USD</th>
        <th scope="col">Today's Exchange Rate</th>
        <th scope="col">Total Cash</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{data["td"]}}</td>
        <td>{{data["ud"]}}</td>
        <td>{{data["currency"]}} TWD</td>
        <td>{{data["total"]}} TWD</td>
      </tr>
    </tbody>
  </table>

  <h5>Cash Adjustment Record</h5>
  <!--å¾bootstrapé‚£é‚Šä¾†çš„,å¯ä»¥å»åƒè€ƒé‚£é‚Šçš„tableçš„ç¯„ä¾‹-->
  <table class="table" style="text-align: center;"> 
    <thead class="table-success">
      <tr>
        <!--col:column-->
        <th scope="col" style="display: none">ID</th>
        <th scope="col">TWD</th>
        <th scope="col">USD</th>
        <th scope="col">Notes</th>
        <th scope="col">Date</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      <!--ç”¨for loopå»æŠŠindex.pyè£¡çš„ç¬¬67è¡Œçš„cash_resultè£¡é¢çš„è³‡æ–™å¡é€²è¡¨æ ¼è£¡é¢-->
      <!--cash_resultæ˜¯å€‹a list of tuple-->
      {% for data in data["cash_result"] %}
      <!--é€™è£¡é¢å°±å¯ä»¥ä½¿ç”¨data["cash_result"]é€™å€‹listè£¡é¢çš„æ¯ä¸€ç­†è³‡æ–™-->
      <tr>
        <!--style="vertical-align: middle":å‚ç›´ç½®ä¸­-->
        <td style="vertical-align: middle; display: none">{{data[0]}}</td>
        <td style="vertical-align: middle">{{data[1]}}</td>
        <td style="vertical-align: middle">{{data[2]}}</td>
        <td style="vertical-align: middle">{{data[3]}}</td>
        <td style="vertical-align: middle">{{data[4]}}</td>
        <td style="width:20%">
          <!--é€™è£¡ä¸èƒ½åªåšä¸€å€‹button,è€Œæ˜¯è¦ä½œä¸€å€‹form,é€™æ˜¯å› ç‚ºæˆ‘å€‘è¦é€éé€™å€‹form,
          ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œåˆªé™¤æ­¤ç­†è³‡æ–™ã€é€™å€‹buttonä¹‹å¾Œ,å®ƒæœƒå¯„é€ä¸€å€‹HTTPçš„POST request
          åˆ°æˆ‘å€‘çš„index.pyçš„ä¼ºæœå™¨,å®ƒå¯„é€requestä¹‹å¾Œ,æˆ‘å€‘çš„ä¼ºæœå™¨å†ä¾†è™•ç†é€™å€‹request-->
          <form action="/cash-delete" method="post" style="display: inline; margin-right: 5px;">
            <!--ä½œä¸€å€‹æ²’äººçœ‹åˆ°çš„<input> tag-->
            <!--ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œåˆªé™¤æ­¤ç­†è³‡æ–™ã€æ™‚,data[0]é€™ç­†è³‡æ–™å°±æœƒè¢«åˆ°å¾Œç«¯çš„ä¼ºæœå™¨-->
            <input type="hidden" name="id" value="{{data[0]}}" />
            <!--btn-primary:è¨­å®šbuttonçš„èƒŒæ™¯æ˜¯è—è‰²-->
            <button class="btn btn-outline-success">Delete</button>
          </form>
          
          <!--æ›´æ–°æŒ‰éˆ•-->
          <form action="/cash-update" method="post" style="display: inline">
            <input type="hidden" name="updateId" value="{{data[0]}}" />
            <button class="btn btn-outline-success">Update</button>
          </form>
        </td>        
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr />
<div id="stock-info">
  <!--&#x1F4C8;æ˜¯è‚¡ç¥¨çš„emoji-->
  <h3>Stock Inventory ğŸ“ˆ</h3>
  <table class="table" style="text-align: center;">
    <thead class="table-success">
      <tr>
        <th scope="col">Stock Code</th>
        <th scope="col">Number of Shares Held</th>
        <th scope="col">Current Stock Price</th>
        <th scope="col">Current Market Value</th>
        <th scope="col">Stock Asset Proportion(%)</th>
        <th scope="col">Total Purchase Cost(including Fees)</th>
        <th scope="col">Average Cost</th>
        <th scope="col">Return Rate(%)</th>
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      {% for d in data["stock_info"] %}
      <tr>
        <!--é€™è£¡çš„dæ˜¯ä¸€å€‹dictionary-->
        <td style="vertical-align: middle">{{d["stock_id"]}}</td>
        <td style="vertical-align: middle">{{d["shares"]}}</td>
        <td style="vertical-align: middle">{{d["current_price"]}}</td>
        <td style="vertical-align: middle">{{d["total_value"]}}</td>
        <td style="vertical-align: middle">{{d["value_percentage"]}}</td>
        <td style="vertical-align: middle">{{d["stock_cost"]}}</td>
        <td style="vertical-align: middle">{{d["average_cost"]}}</td>
        <td style="vertical-align: middle" class="{% if d['rate_of_return'] < 0 %} text-success{% else %} text-danger{% endif %}">
          {{ d["rate_of_return"] }}
        </td>
        <td>
          <form action="/stock-delete" method="post">
            <!--ä½œä¸€å€‹æ²’äººçœ‹åˆ°çš„<input> tag-->
            <!--ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œåˆªé™¤æ­¤ç­†è³‡æ–™ã€æ™‚,data[0]é€™ç­†è³‡æ–™å°±æœƒè¢«åˆ°å¾Œç«¯çš„ä¼ºæœå™¨-->
            <input type="hidden" name="stock_id" value="{{d['stock_id']}}" />
            <!--btn-primary:è¨­å®šbuttonçš„èƒŒæ™¯æ˜¯è—è‰²-->
            <button class="btn btn-outline-success">Delete</button>
          </form>

          <!--æ›´æ–°æŒ‰éˆ•-->
          <form action="/stock-update" method="post" style="margin-top: 10px">
            <input type="hidden" name="updateStockId" value="{{d['stock_id']}}" />
            <button class="btn btn-outline-success">Update</button>
          </form>

           <!--æ˜ç´°æŒ‰éˆ•-->
           <form action="/stock-statements" method="post" style="margin-top: 10px">
            <input type="hidden" name="statementsId" value="{{d['stock_id']}}" />
            <button class="btn btn-outline-success">Details</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr />
<!--ä¸æ‡‚CSSæ²’é—œè¥¿,å› ç‚ºé€™éƒ½æ˜¯ç¶²é èª²ç¨‹è£¡çš„å…§å®¹-->
<div id="chart" style="display: flex; flex-wrap: wrap" >
  <!--å»åˆ¤æ–·è¦ä¸è¦é¡¯ç¤ºfigure-->
  {% if data["show_pic_1"] %}
  <figure style="flex: 0 1 500px; margin: 10px">
    <figcaption>Stock Warehouse Occupancy Chart</figcaption>
    <img style="width: 100%" src="/static/piechart.jpg" alt="è‚¡ç¥¨åº«å­˜å æ¯”åœ–" />
  </figure>
  {% endif %} {% if data["show_pic_2"] %}
  <figure style="flex: 0 1 500px; margin: 15px">
    <figcaption>Asset Ratio Chart</figcaption>
    <img style="width: 100%" src="/static/piechart2.jpg" alt="è³‡ç”¢æ¯”ä¾‹å æ¯”åœ–" />
  </figure>
  {% endif %}
</div>

<hr />
<div id="footer" style="text-align: right; padding: 10px 0">
  Today's Exchange Rate Data Source:
  <a href="https://tw.rter.info/howto_currencyapi.php" target="_blank">
    Global Real-Time Exchange Rate API
  </a>
</div>
</div> <!--è™›åŒ–çµæŸ-->

<script>
  window.onload = function () {
    // æª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ "formSubmitted" æ¨™è¨˜
    if (!localStorage.getItem("formSubmitted")) {
      // å¦‚æœå°šæœªæäº¤è¡¨å–®, é¡¯ç¤ºæ¨¡æ…‹æ¡†
      var introModal = document.getElementById("introModal");
        introModal.style.display = "block"; // é¡¯ç¤ºæ¨¡æ…‹æ¡†

        var myModal = new bootstrap.Modal(introModal); // åˆå§‹åŒ– Bootstrap Modal
        myModal.show();

        // åªè™›åŒ–èƒŒæ™¯,ä¸è™›åŒ–å½ˆè·³è¦–çª—(åˆ©ç”¨"main-content"åŒ…è£¹ä½éœ€è¦è™›åŒ–çš„åœ°æ–¹)
        document.getElementById("main-content").classList.add("blurred");

        // å¦‚æœå°šæœªæäº¤è¡¨å–®,å¼·åˆ¶é¡¯ç¤ºæ¨¡æ…‹æ¡†
        // var myModal = new bootstrap.Modal(document.getElementById("introModal"));
        // myModal.show();
    }
    else {
        // å¦‚æœå·²æäº¤éè¡¨å–®ï¼Œå‰‡ç›´æ¥è¼‰å…¥è³‡æ–™
        console.log("è·³éè¡¨å–®"); //æ¸¬è©¦ç”¨
    }

};
  //ç™»å…¥é é¢çš„ã€Œç¢ºèªã€button
  function handleFormSubmit(event) {
    event.preventDefault(); // é˜²æ­¢è¡¨å–®é»˜èªæäº¤

    var userCodeInput = document.getElementById("userCodeInput").value;
    var pwdInput = document.getElementById("pwdInput").value;

    fetch("/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ userCodeInput: userCodeInput, pwdInput:pwdInput }), // è½‰æ›ç‚º URL ç·¨ç¢¼æ ¼å¼
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            // è¡¨å–®æäº¤æˆåŠŸ,å„²å­˜å·²æäº¤çš„ç‹€æ…‹åˆ°localStorage(é€™æ¨£å³ä½¿é–‹å…¶ä»–åˆ†é ä¹Ÿæœƒä¿ç•™ç´€éŒ„)
            //sessionStorage:åªæœƒä¿ç•™ç•¶å‰é é¢çš„ç‹€æ…‹
            localStorage.setItem("formSubmitted", "true");

            // éš±è—å½ˆå‡ºè¦–çª—ä¸¦é‡æ–°è¼‰å…¥é é¢
            var myModal = bootstrap.Modal.getInstance(document.getElementById("introModal"));
            myModal.hide();

            // ä¿æŒèƒŒæ™¯æ¨¡ç³Š,ç«‹å³åˆ·æ–°é é¢
            setTimeout(() => {
                location.reload(); // ç«‹å³åˆ·æ–°é é¢,å±•ç¤ºæœ€æ–°è³‡æ–™
             }, 0);

            // åœ¨3ç§’å¾Œç§»é™¤æ¨¡ç³Šæ•ˆæœ
            setTimeout(() => {
                document.getElementById("main-content").classList.remove("blurred");
            }, 3000); 

            //ç§»é™¤éœ€åŒ–èƒŒæ™¯
            //myModal._element.addEventListener('hidden.bs.modal', function () {
            //document.getElementById("main-content").classList.remove("blurred");});
            
            location.reload();
        } else {
            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦ä¿æŒå½ˆå‡ºè¦–çª—é–‹å•Ÿ
            var inputError = document.getElementById("inputError");
            inputError.textContent = data.message; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            inputError.style.display = "block"; // é¡¯ç¤ºéŒ¯èª¤æç¤º

            // åœ¨1.3ç§’å¾Œéš±è—éŒ¯èª¤è¨Šæ¯
            setTimeout(() => {
                inputError.style.display = "none"; // éš±è—éŒ¯èª¤æç¤º
            }, 1300); // 1300æ¯«ç§’ï¼Œå³1.3ç§’
            
        }
    })
    .catch(error => {
        console.error("ç¶²è·¯éŒ¯èª¤:", error);
    });
    }

    //è¨»å†Šé é¢çš„ã€Œç¢ºèªã€button
    function handleRegistration(event) {
    event.preventDefault(); // é˜²æ­¢è¡¨å–®é»˜èªæäº¤

    var regUserCode = document.getElementById("regUserCode").value;
    var regPwd = document.getElementById("regPwd").value;

    fetch("/register", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ regUserCode: regUserCode, regPwd: regPwd }), // è½‰æ›ç‚º URL ç·¨ç¢¼æ ¼å¼
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            // è¡¨å–®æäº¤æˆåŠŸ,å„²å­˜å·²æäº¤çš„ç‹€æ…‹åˆ°localStorage(é€™æ¨£å³ä½¿é–‹å…¶ä»–åˆ†é ä¹Ÿæœƒä¿ç•™ç´€éŒ„)
            //sessionStorage:åªæœƒä¿ç•™ç•¶å‰é é¢çš„ç‹€æ…‹
            localStorage.setItem("formSubmitted", "true");

            // éš±è—å½ˆå‡ºè¦–çª—ä¸¦é‡æ–°è¼‰å…¥é é¢
            var myModal = bootstrap.Modal.getInstance(document.getElementById("introModal"));
            myModal.hide();

            // ä¿æŒèƒŒæ™¯æ¨¡ç³Š,ç«‹å³åˆ·æ–°é é¢
            setTimeout(() => {
                location.reload(); // ç«‹å³åˆ·æ–°é é¢,å±•ç¤ºæœ€æ–°è³‡æ–™
             }, 0);

            // åœ¨3ç§’å¾Œç§»é™¤æ¨¡ç³Šæ•ˆæœ
            setTimeout(() => {
                document.getElementById("main-content").classList.remove("blurred");
            }, 3000); // å»¶é²3ç§’ç§»é™¤æ¨¡ç³Šæ•ˆæœ

            //ç§»é™¤éœ€åŒ–èƒŒæ™¯(åŸå§‹code)
            // myModal._element.addEventListener('hidden.bs.modal', function () {
            // document.getElementById("main-content").classList.remove("blurred");});
            
            location.reload();
        } else {
            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦ä¿æŒå½ˆå‡ºè¦–çª—é–‹å•Ÿ
            var regError = document.getElementById("regError");
            regError.textContent = data.message; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            regError.style.display = "block"; // é¡¯ç¤ºéŒ¯èª¤æç¤º

            // åœ¨1.3ç§’å¾Œéš±è—éŒ¯èª¤è¨Šæ¯
            setTimeout(() => {
                regError.style.display = "none"; // éš±è—éŒ¯èª¤æç¤º
            }, 1300); // 1300æ¯«ç§’ï¼Œå³1.3ç§’
            
        }
    })
    .catch(error => {
        console.error("ç¶²è·¯éŒ¯èª¤:", error);
    });
    }

    function openRegistrationPage() {
      // éš±è—ç™»å…¥è¡¨å–®ï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®
      document.getElementById('registrationForm').style.display = 'block';
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('exampleModalLabel').textContent = "è¨»å†Šå¸³è™Ÿ";

      //å¯ä»¥ç”¨ä¾†æ¸¬è©¦buttonæ˜¯å¦æœ‰è¢«click
      // alert("è¨»å†ŠæŒ‰éˆ•è¢«é»æ“Šäº†ï¼");
    }

    function showLoginForm() {
      // éš±è—è¨»å†Šè¡¨å–®ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®
      document.getElementById('loginPage').style.display = 'block';
      document.getElementById('registrationForm').style.display = 'none';
      document.getElementById('exampleModalLabel').textContent = "æ­¡è¿ğŸ‘ğŸ‘ğŸ‘";
    }
</script>

<script>
  function filterInput(input) {
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é…å…è¨±çš„å­—ç¬¦(è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šç¬¦è™Ÿ)
    input.value = input.value.replace(/[^A-Za-z0-9!@#$%^&*()_+={}\[\]:;\"'<>,.?/\\|`~\-]/g, ''); 
    // ä¸Šé¢çš„æ­£å‰‡è¡¨é”å¼æœƒç§»é™¤ä»»ä½•ä¸åœ¨å…è¨±ç¯„åœå…§çš„å­—ç¬¦
  }
</script>
{% endblock %}
